CREATE EXTERNAL TABLE text_table(                                                                                                                                                                                                                                                                                     
   cs_refid string,                                                                                                                                                                                                                                                                                                      
   ngn_refid string,                                                                                                                                                                                                                                                                                                     
   starttime bigint,                                                                                                                                                                                                                                                                                                     
   millisec smallint,                                                                                                                                                                                                                                                                                                    
   service_type smallint,                                                                                                                                                                                                                                                                                                
   callerno string,                                                                                                                                                                                                                                                                                                      
   callertype smallint,                                                                                                                                                                                                                                                                                                  
   callerimsi string,                                                                                                                                                                                                                                                                                                    
   calledno string,                                                                                                                                                                                                                                                                                                      
   calledtype smallint,                                                                                                                                                                                                                                                                                                  
   calledimsi string,                                                                                                                                                                                                                                                                                                    
   alert_time bigint,                                                                                                                                                                                                                                                                                                    
   answer_time bigint,                                                                                                                                                                                                                                                                                                   
   disconn_time bigint,                                                                                                                                                                                                                                                                                                  
   end_time bigint,                                                                                                                                                                                                                                                                                                      
   causelst string,                                                                                                                                                                                                                                                                                                      
   protocols string,                                                                                                                                                                                                                                                                                                     
   status smallint,                                                                                                                                                                                                                                                                                                      
   reserved1 string,                                                                                                                                                                                                                                                                                                     
   reserved2 string,                                                                                                                                                                                                                                                                                                     
   reserved3 string,                                                                                                                                                                                                                                                                                                     
   reserved4 string,                                                                                                                                                                                                                                                                                                     
   signalstorage string,                                                                                                                                                                                                                                                                                                 
   cldnoa smallint,                                                                                                                                                                                                                                                                                                      
   cplnoa smallint,                                                                                                                                                                                                                                                                                                      
   firfailprot bigint,                                                                                                                                                                                                                                                                                                   
   firfailmsg smallint,                                                                                                                                                                                                                                                                                                  
   firfailcause bigint,                                                                                                                                                                                                                                                                                                  
   callid string,                                                                                                                                                                                                                                                                                                        
   callduration bigint,                                                                                                                                                                                                                                                                                                  
   rel_time bigint,                                                                                                                                                                                                                                                                                                      
   rlc_time bigint,                                                                                                                                                                                                                                                                                                      
   layer1id smallint,                                                                                                                                                                                                                                                                                                    
   layer2id smallint,                                                                                                                                                                                                                                                                                                    
   layer3id smallint,                                                                                                                                                                                                                                                                                                    
   layer4id smallint,                                                                                                                                                                                                                                                                                                    
   layer5id smallint,                                                                                                                                                                                                                                                                                                    
   layer6id smallint,                                                                                                                                                                                                                                                                                                    
   formatcallerno string,                                                                                                                                                                                                                                                                                                
   formatcallertype smallint,                                                                                                                                                                                                                                                                                            
   formatcalledno string,                                                                                                                                                                                                                                                                                                
   formatcalledtype smallint,                                                                                                                                                                                                                                                                                            
   orgcalledno string,                                                                                                                                                                                                                                                                                                   
   orgcalledtype smallint,                                                                                                                                                                                                                                                                                               
   orgcallednoa smallint,                                                                                                                                                                                                                                                                                                
   csfbind smallint,                                                                                                                                                                                                                                                                                                     
   failtype string,                                                                                                                                                                                                                                                                                                      
   firfailpd smallint,                                                                                                                                                                                                                                                                                                   
   firfailside smallint,                                                                                                                                                                                                                                                                                                 
   callerrelcgi string,                                                                                                                                                                                                                                                                                                  
   calledrelcgi string,                                                                                                                                                                                                                                                                                                  
   ni smallint,                                                                                                                                                                                                                                                                                                          
   opc int,                                                                                                                                                                                                                                                                                                              
   srcip bigint,                                                                                                                                                                                                                                                                                                         
   poolid bigint,                                                                                                                                                                                                                                                                                                        
   bssapranap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,CIC:bigint,TMSI:string,IMEI:string,SMCADDR:string,OPPNUMBER:string,CALLDURATION:bigint,PROTOCOLS:int,PD:smallint,CAUSE:bigint>>,                                                                  
   cap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,OGT:string,DGT:string,OSSN:smallint,DSSN:smallint,LOCNUM:string,CALLDURATION:bigint,PROTOCOL:bigint,RELTYPE:smallint,CAUSE:bigint>>,                                                                     
   gsmmap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,OGT:string,DGT:string,OSSN:smallint,DSSN:smallint,CDRSTAT:smallint,PMSISDN:string,SMSCNO:string,PROTOCOL:bigint,RELTYPE:smallint,CAUSE:bigint>>,                                                      
   isup array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,CIC:smallint,ITC:smallint,ITR:smallint,CALLERNO:string,FWDNO:string,LOCNUM:string,OLDNO:string,GAP:string,CALLDURATION:bigint,PPD:bigint,CAUSE:bigint>>,                                                
   bicc array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,CIC:smallint,ITC:smallint,ITR:smallint,CALLERNO:string,FWDNO:string,LOCNUM:string,OLDNO:string,CALLDURATION:bigint,PPD:bigint,CAUSE:bigint>>,                                                           
   sip array<struct<CALLID:string,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,ITC:smallint,ITR:smallint,INVITE_RESPONSE_TIME:bigint,CALLDURATION:bigint,PPD:bigint,RESPONSE_CODE:bigint>>,                                                                                                           
   siprtcp array<struct<INTERARR_JITTER:bigint,RDTRIP_DELAY:bigint,MOS:bigint,CONVER_R:bigint,PACKET_LSTRATE:bigint>>,                                                                                                                                                                                                   
   inap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,OSSN:smallint,DSSN:smallint,OGT:string,DGT:string>>,                                                                                                                                                    
   megaco array<struct<LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,ITC:smallint,ITR:smallint,POST_DIAL_DELAY:bigint,DIAL_TONE_DELAY:bigint,CALL_RURATION:bigint,RESPONSE_CODE:bigint>>,                                                                                                              
   megacortcp array<struct<PACKET_LOSS:bigint,PACKET_RCV:bigint,PACKET_SENT:bigint,JITTER:bigint,DELAY:bigint,MOS:bigint,R_FACTOR:bigint,PACKETS_LOST_PERCENT:smallint>>,                                                                                                                                                
   mgcp array<struct<LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,POST_DIAL_DELAY:bigint,DIAL_TONE_DELAY:bigint,CALLDURATION:bigint,RESPONSE_CODE:bigint>>,                                                                                                                                           
   mgcprtcp array<struct<PACKET_LOSS:bigint,PACKET_RCV:bigint,PACKET_SENT:bigint,JITTER:bigint,DELAY:bigint,PACKETS_LOST_PERCENT:smallint>>,                                                                                                                                                                             
   media array<struct<RTCP_AVER_JITTER:bigint,RTCP_MAX_JITTER:bigint,RTCP_AVER_TRIPDELAY:bigint,RTCP_MAX_TRIPDELAY:bigint,RTCP_PACKETS_RECV:bigint,RTCP_AVG_PACKETS_LOST_PERCENT:smallint,AVER_JITTER:bigint,MAX_JITTER:bigint,BYTES_RECV:bigint,PACKETS_RECV:bigint,PACKETS_LOST:bigint,MOS:double,R_FACTOR:bigint>>,   
   imsdiameter array<struct<LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,USERNAME:string,IMPU:string,SERVERNAME:string,NAI:string,RESULTCODE:bigint,EX_RESULTCODE:bigint>>)                                                                                                                           
row format delimited fields terminated by '|'  
collection items terminated by ','
map keys terminated by '#'
stored as textfile
location 'spark_home/wfdata';

CREATE TABLE parquet_table(                                                                                                                                                                                                                                                                                     
   cs_refid string,                                                                                                                                                                                                                                                                                                      
   ngn_refid string,                                                                                                                                                                                                                                                                                                     
   starttime bigint,                                                                                                                                                                                                                                                                                                     
   millisec smallint,                                                                                                                                                                                                                                                                                                    
   service_type smallint,                                                                                                                                                                                                                                                                                                
   callerno string,                                                                                                                                                                                                                                                                                                      
   callertype smallint,                                                                                                                                                                                                                                                                                                  
   callerimsi string,                                                                                                                                                                                                                                                                                                    
   calledno string,                                                                                                                                                                                                                                                                                                      
   calledtype smallint,                                                                                                                                                                                                                                                                                                  
   calledimsi string,                                                                                                                                                                                                                                                                                                    
   alert_time bigint,                                                                                                                                                                                                                                                                                                    
   answer_time bigint,                                                                                                                                                                                                                                                                                                   
   disconn_time bigint,                                                                                                                                                                                                                                                                                                  
   end_time bigint,                                                                                                                                                                                                                                                                                                      
   causelst string,                                                                                                                                                                                                                                                                                                      
   protocols string,                                                                                                                                                                                                                                                                                                     
   status smallint,                                                                                                                                                                                                                                                                                                      
   reserved1 string,                                                                                                                                                                                                                                                                                                     
   reserved2 string,                                                                                                                                                                                                                                                                                                     
   reserved3 string,                                                                                                                                                                                                                                                                                                     
   reserved4 string,                                                                                                                                                                                                                                                                                                     
   signalstorage string,                                                                                                                                                                                                                                                                                                 
   cldnoa smallint,                                                                                                                                                                                                                                                                                                      
   cplnoa smallint,                                                                                                                                                                                                                                                                                                      
   firfailprot bigint,                                                                                                                                                                                                                                                                                                   
   firfailmsg smallint,                                                                                                                                                                                                                                                                                                  
   firfailcause bigint,                                                                                                                                                                                                                                                                                                  
   callid string,                                                                                                                                                                                                                                                                                                        
   callduration bigint,                                                                                                                                                                                                                                                                                                  
   rel_time bigint,                                                                                                                                                                                                                                                                                                      
   rlc_time bigint,                                                                                                                                                                                                                                                                                                      
   layer1id smallint,                                                                                                                                                                                                                                                                                                    
   layer2id smallint,                                                                                                                                                                                                                                                                                                    
   layer3id smallint,                                                                                                                                                                                                                                                                                                    
   layer4id smallint,                                                                                                                                                                                                                                                                                                    
   layer5id smallint,                                                                                                                                                                                                                                                                                                    
   layer6id smallint,                                                                                                                                                                                                                                                                                                    
   formatcallerno string,                                                                                                                                                                                                                                                                                                
   formatcallertype smallint,                                                                                                                                                                                                                                                                                            
   formatcalledno string,                                                                                                                                                                                                                                                                                                
   formatcalledtype smallint,                                                                                                                                                                                                                                                                                            
   orgcalledno string,                                                                                                                                                                                                                                                                                                   
   orgcalledtype smallint,                                                                                                                                                                                                                                                                                               
   orgcallednoa smallint,                                                                                                                                                                                                                                                                                                
   csfbind smallint,                                                                                                                                                                                                                                                                                                     
   failtype string,                                                                                                                                                                                                                                                                                                      
   firfailpd smallint,                                                                                                                                                                                                                                                                                                   
   firfailside smallint,                                                                                                                                                                                                                                                                                                 
   callerrelcgi string,                                                                                                                                                                                                                                                                                                  
   calledrelcgi string,                                                                                                                                                                                                                                                                                                  
   ni smallint,                                                                                                                                                                                                                                                                                                          
   opc int,                                                                                                                                                                                                                                                                                                              
   srcip bigint,                                                                                                                                                                                                                                                                                                         
   poolid bigint,                                                                                                                                                                                                                                                                                                        
   bssapranap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,CIC:bigint,TMSI:string,IMEI:string,SMCADDR:string,OPPNUMBER:string,CALLDURATION:bigint,PROTOCOLS:int,PD:smallint,CAUSE:bigint>>,                                                                  
   cap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,OGT:string,DGT:string,OSSN:smallint,DSSN:smallint,LOCNUM:string,CALLDURATION:bigint,PROTOCOL:bigint,RELTYPE:smallint,CAUSE:bigint>>,                                                                     
   gsmmap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,OGT:string,DGT:string,OSSN:smallint,DSSN:smallint,CDRSTAT:smallint,PMSISDN:string,SMSCNO:string,PROTOCOL:bigint,RELTYPE:smallint,CAUSE:bigint>>,                                                      
   isup array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,CIC:smallint,ITC:smallint,ITR:smallint,CALLERNO:string,FWDNO:string,LOCNUM:string,OLDNO:string,GAP:string,CALLDURATION:bigint,PPD:bigint,CAUSE:bigint>>,                                                
   bicc array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,CIC:smallint,ITC:smallint,ITR:smallint,CALLERNO:string,FWDNO:string,LOCNUM:string,OLDNO:string,CALLDURATION:bigint,PPD:bigint,CAUSE:bigint>>,                                                           
   sip array<struct<CALLID:string,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,ITC:smallint,ITR:smallint,INVITE_RESPONSE_TIME:bigint,CALLDURATION:bigint,PPD:bigint,RESPONSE_CODE:bigint>>,                                                                                                           
   siprtcp array<struct<INTERARR_JITTER:bigint,RDTRIP_DELAY:bigint,MOS:bigint,CONVER_R:bigint,PACKET_LSTRATE:bigint>>,                                                                                                                                                                                                   
   inap array<struct<NI:smallint,OPC:int,DPC:int,LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,OSSN:smallint,DSSN:smallint,OGT:string,DGT:string>>,                                                                                                                                                    
   megaco array<struct<LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,ITC:smallint,ITR:smallint,POST_DIAL_DELAY:bigint,DIAL_TONE_DELAY:bigint,CALL_RURATION:bigint,RESPONSE_CODE:bigint>>,                                                                                                              
   megacortcp array<struct<PACKET_LOSS:bigint,PACKET_RCV:bigint,PACKET_SENT:bigint,JITTER:bigint,DELAY:bigint,MOS:bigint,R_FACTOR:bigint,PACKETS_LOST_PERCENT:smallint>>,                                                                                                                                                
   mgcp array<struct<LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,POST_DIAL_DELAY:bigint,DIAL_TONE_DELAY:bigint,CALLDURATION:bigint,RESPONSE_CODE:bigint>>,                                                                                                                                           
   mgcprtcp array<struct<PACKET_LOSS:bigint,PACKET_RCV:bigint,PACKET_SENT:bigint,JITTER:bigint,DELAY:bigint,PACKETS_LOST_PERCENT:smallint>>,                                                                                                                                                                             
   media array<struct<RTCP_AVER_JITTER:bigint,RTCP_MAX_JITTER:bigint,RTCP_AVER_TRIPDELAY:bigint,RTCP_MAX_TRIPDELAY:bigint,RTCP_PACKETS_RECV:bigint,RTCP_AVG_PACKETS_LOST_PERCENT:smallint,AVER_JITTER:bigint,MAX_JITTER:bigint,BYTES_RECV:bigint,PACKETS_RECV:bigint,PACKETS_LOST:bigint,MOS:double,R_FACTOR:bigint>>,   
   imsdiameter array<struct<LNKSRCIP:string,LNKSRCPORT:int,LNKDESTIP:string,LNKDESTPORT:int,USERNAME:string,IMPU:string,SERVERNAME:string,NAI:string,RESULTCODE:bigint,EX_RESULTCODE:bigint>>)                                                                                                                           
partitioned by (hour int,last_msisdn string)
STORED AS PARQUET;


set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.exec.max.dynamic.partitions=100000;

insert into table parquet_table partition (hour,last_msisdn) select *,hour(from_unixtime(starttime,'yyyy-MM-dd HH:mm:ss')),substr(calledno,-1)  from text_table;

select * from parquet_table;